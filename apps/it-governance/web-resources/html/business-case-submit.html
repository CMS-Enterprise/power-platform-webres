<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Business Case Header</title>

    <style>
      /* Base */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        line-height: 1.428571429;
        color: #323130;
        background-color: #faf9f8;
        margin: 0;
        padding: 12px;
      }

      /* Primary button */
      .btn-primary {
        background-color: #0078d4;
        border: 1px solid #0078d4;
        color: #ffffff;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 400;
        border-radius: 5px;
        cursor: pointer;
        transition:
          background-color 0.15s ease-in-out,
          border-color 0.15s ease-in-out;
      }
      .btn-primary:hover {
        background-color: #106ebe;
        border-color: #106ebe;
      }
      .btn-primary:focus {
        outline: 1px solid #ffffff;
        outline-offset: 2px;
        box-shadow: 0 0 0 2px #0078d4;
      }

      /* Success alert */
      .alert {
        padding: 12px 16px;
        margin: 12px 0;
        border-radius: 4px;
        border-left: 6px solid #107c10;
        background-color: #dff6dd;
        color: #0b5a0b;
      }

      /* Error alert */
      .alert-error {
        border-left-color: #a80000;
        background-color: #fde7e9;
        color: #a80000;
      }

      /* Hide/show utility */
      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        body {
          padding: 8px;
        }
      }
    </style>

    <script>
      const SUBMITTED_BOOL = "cr69a_initialbusinesscasesubmitted";
      const SUBMITTED_DATE = "cr69a_initialbusinesscasesubmitteddate";
      const INITIAL_BUSINESS_CASE = "cr69a_businesscase";
      const READY_FOR_REVIEW = "cr69a_readyforreview";

      function getParentForm() {
        return parent && parent.Xrm && parent.Xrm.Page ? parent.Xrm.Page : null;
      }

      function getAttr(form, schema) {
        return form ? form.getAttribute(schema) : null;
      }

      function showMessage(text, isError) {
        var box = document.getElementById("submitStatus");
        if (!box) return;

        box.textContent =
          text || "Draft Business Case submitted. Waiting for feedback.";
        box.classList.remove("hidden");

        if (isError) {
          box.classList.add("alert-error");
        } else {
          box.classList.remove("alert-error");
        }
      }

      function hideMessage() {
        var box = document.getElementById("submitStatus");
        if (!box) return;
        box.classList.add("hidden");
        box.classList.remove("alert-error");
        box.textContent = "";
      }

      function showSuccess(text) {
        showMessage(text, false);
      }

      function showError(text) {
        showMessage(text, true);
      }

      function setSubmitButtonHidden(hidden) {
        var submitButton = document.getElementById("submitBusinessCaseButton");
        if (!submitButton) return;
        submitButton.classList.toggle("hidden", !!hidden);
      }

      // âœ… UI depends ONLY on Ready For Review
      function updateUIFromReadyForReview() {
        const form = getParentForm();
        if (!form) return;

        const rfr = getAttr(form, READY_FOR_REVIEW);
        const ready = !!(rfr && rfr.getValue());

        if (ready) {
          showSuccess("Draft Business Case submitted. Waiting for feedback.");
          setSubmitButtonHidden(true);
        } else {
          // Back to requester turn (e.g., edit request came in)
          hideMessage();
          setSubmitButtonHidden(false);
        }
      }

      function hookReadyForReviewOnChange() {
        const form = getParentForm();
        if (!form) return;

        const rfr = getAttr(form, READY_FOR_REVIEW);
        if (rfr && rfr.addOnChange) {
          rfr.addOnChange(updateUIFromReadyForReview);
        }
      }

      function submitBusinessCase() {
        try {
          const form = getParentForm();
          if (!form) {
            console.error("Could not access parent form context.");
            showError("Unable to access form. Please refresh and try again.");
            return;
          }

          // Validation stays (this is business logic, not UI gating)
          const initialBusinessCase = getAttr(form, INITIAL_BUSINESS_CASE);
          if (!initialBusinessCase || initialBusinessCase.getValue() == null) {
            showError(
              "Please fill out the Business Case field before submitting.",
            );
            return;
          }

          // 1) Mark as submitted
          const submittedAttr = getAttr(form, SUBMITTED_BOOL);
          if (submittedAttr) submittedAttr.setValue(true);

          const submittedDateAttr = getAttr(form, SUBMITTED_DATE);
          if (submittedDateAttr && !submittedDateAttr.getValue()) {
            submittedDateAttr.setValue(new Date());
          }

          // 2) Hand off turn to admin
          const readyForReview = getAttr(form, READY_FOR_REVIEW);
          if (readyForReview) readyForReview.setValue(true);

          // 3) Save form
          form.data.save().then(
            function () {
              if (parent.lockAllFields) {
                parent.lockAllFields(form);
              } else {
                console.warn(
                  "lockAllFields function not found on parent window",
                );
              }

              // reflect latest RFR state
              updateUIFromReadyForReview();
            },
            function (err) {
              console.error(
                "Save failed:",
                err && err.message ? err.message : err,
              );
              showError(
                "Failed to submit. Please try again or contact support.",
              );
            },
          );
        } catch (e) {
          console.error("Unexpected error during submit:", e);
          showError("An unexpected error occurred. Please contact support.");
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        hookReadyForReviewOnChange();
        updateUIFromReadyForReview();
      });
    </script>
  </head>

  <body>
    <div
      id="submitStatus"
      class="alert hidden"
      role="status"
      aria-live="polite"
    ></div>

    <div style="text-align: right">
      <button
        id="submitBusinessCaseButton"
        class="btn-primary"
        onclick="submitBusinessCase()"
      >
        Submit Business Case
      </button>
    </div>
  </body>
</html>
