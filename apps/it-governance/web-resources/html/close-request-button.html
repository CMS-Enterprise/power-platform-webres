<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Close Request Header</title>

    <style>
      /* Base */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        line-height: 1.428571429;
        color: #323130;
        background-color: #faf9f8;
        margin: 0;
        padding: 12px;
      }

      /* Primary button */
      .btn-primary {
        background-color: #0078d4;
        border: 1px solid #0078d4;
        color: #ffffff;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 400;
        border-radius: 5px;
        cursor: pointer;
        transition:
          background-color 0.15s ease-in-out,
          border-color 0.15s ease-in-out;
      }
      .btn-primary:hover {
        background-color: #106ebe;
        border-color: #106ebe;
      }
      .btn-primary:focus {
        outline: 1px solid #ffffff;
        outline-offset: 2px;
        box-shadow: 0 0 0 2px #0078d4;
      }

      /* Success alert */
      .alert {
        padding: 12px 16px;
        margin: 12px 0;
        border-radius: 4px;
        border-left: 6px solid #107c10;
        background-color: #dff6dd;
        color: #0b5a0b;
      }

      /* Hide/show utility */
      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        body {
          padding: 8px;
        }
      }
    </style>

    <script>
      const SUBMITTED_BOOL = "cr69a_initialbusinesscasesubmitted";
      const SUBMITTED_DATE = "cr69a_decisiondate";

      function getParentForm() {
        return parent && parent.Xrm && parent.Xrm.Page ? parent.Xrm.Page : null;
      }

      function getAttr(form, schema) {
        return form ? form.getAttribute(schema) : null;
      }

      function showSuccess(text) {
        var container = document.getElementById("closeStatus");
        if (!container) return;
        container.textContent = text || "Intake Request successfully closed.";
        container.classList.remove("hidden");
        var submitButton = document.getElementById("closeRequestButton");
        if (!submitButton) return;
        submitButton.classList.add("hidden");
      }

      function shouldShowSuccessFromFields() {
        const form = getParentForm();
        if (!form) return false;

        const submittedAttr = getAttr(form, SUBMITTED_BOOL);
        const submittedDateAttr = getAttr(form, SUBMITTED_DATE);

        const isSubmitted = submittedAttr && submittedAttr.getValue() === true;
        const hasDate = submittedDateAttr && !!submittedDateAttr.getValue();

        return isSubmitted || hasDate;
      }

      function initBannerFromFields() {
        if (shouldShowSuccessFromFields()) {
          showSuccess("Intake Request successfully closed.");
        }
      }

      function closeRequest() {
        try {
          const form = getParentForm();
          if (!form) {
            console.error("Could not access parent form context.");
            return;
          }

          // 1) Mark as submitted
          const submittedAttr = getAttr(form, SUBMITTED_BOOL);
          if (submittedAttr) submittedAttr.setValue(true);

          const submittedDateAttr = getAttr(form, SUBMITTED_DATE);
          if (submittedDateAttr && !submittedDateAttr.getValue()) {
            submittedDateAttr.setValue(new Date());
          }

          const rfr = form.getAttribute("cr69a_readyforreview");
          if (rfr) rfr.setValue(true);

          // 2) Save form
          form.data.save().then(
            function () {
              showSuccess("System Intake Request Closed.");
            },
            function (err) {
              console.error(
                "Save failed:",
                err && err.message ? err.message : err,
              );
            },
          );
        } catch (e) {
          console.error("Unexpected error during close request:", e);
        }
      }

      document.addEventListener("DOMContentLoaded", initBannerFromFields);
    </script>
  </head>

  <body>
    <div
      id="closeStatus"
      class="alert hidden"
      role="status"
      aria-live="polite"
    ></div>

    <div style="text-align: right">
      <button
        id="closeRequestButton"
        class="btn-primary"
        onclick="closeRequest()"
      >
        Close Request
      </button>
    </div>
  </body>
</html>
